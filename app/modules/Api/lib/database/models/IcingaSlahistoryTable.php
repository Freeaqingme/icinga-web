<?php

/**
 * IcingaConfigfiles
 *
 * This class has been auto-generated by the Doctrine ORM Framework
 *
 * @package    ##PACKAGE##
 * @subpackage ##SUBPACKAGE##
 * @author     ##NAME## <##EMAIL##>
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class IcingaSlahistoryTable extends Doctrine_Table {

    private static function registerSLAQueries($prefix, $driver) {
        switch($driver) {
            case 'icingaOracle':
            case 'oracle':
                self::registerOracleQueries($prefix);
                break;
            case 'mysql':
                self::registerMysqlQueries($prefix);
                break;
            case 'pgsql':
                self::registerPsqlQueries($prefix);
        }
    }
    
    private static function registerOracleQueries($prefix) {    
        $query = "
        WITH slatable AS (
            SELECT 
                (state*(scheduled_downtime-1)*-1) as sla_state, 
                object_id, 
                scheduled_downtime, 
                SUM(
                    COALESCE(
                        acknowledgement_time-start_time,
                        end_time-start_time,
                        CURRENT_DATE-start_time
                    )
                 )*60*60*24 AS duration 
             FROM ".$prefix."slahistory
             GROUP BY 
                 sla_state, 
                 object_id, 
                 scheduled_downtime
        ),
        completeDuration AS (
             SELECT object_id,
                SUM(
                    COALESCE(
                        acknowledgement_time-start_time,
                        end_time-start_time,
                        CURRENT_DATE-start_time
                    )*60*60*24
                ) AS complete 
              FROM ".$prefix."slahistory 
              GROUP BY object_id
        ) 
        SELECT 
            s.object_id, 
            s.sla_state, 
            SUM(s.duration/c.complete*100)
        FROM slatable s 
        INNER JOIN 
            completeDuration c 
            ON 
                c.object_id = s.object_id          
        GROUP BY s.object_id, s.sla_state
";
    }   

    public static function registerMysqlQueries($prefix) {    
        return  "
        SELECT 
            slahistory_main.sla_state, 
            slahistory_main.object_id, 
            SUM(slahistory_main.duration/s.complete*100) 
        FROM
            (SELECT 
                object_id,
                state*(scheduled_downtime-1)*-1 as sla_state,
                SUM(
                    COALESCE(
                        UNIX_TIMESTAMP(acknowledgement_time)-UNIX_TIMESTAMP(start_time),
                        UNIX_TIMESTAMP(end_time)-UNIX_TIMESTAMP(start_time),
                        UNIX_TIMESTAMP(now())-UNIX_TIMESTAMP(start_time)
                    )
                ) as duration          
             FROM ".$prefix."slahistory 
             GROUP BY 
                 state*(scheduled_downtime-1)*-1,
                 object_id
             ) slahistory_main 
             INNER JOIN (
                 SELECT object_id,
                 SUM(
                     COALESCE(
                         UNIX_TIMESTAMP(acknowledgement_time)-UNIX_TIMESTAMP(start_time),
                         UNIX_TIMESTAMP(end_time)-UNIX_TIMESTAMP(start_time),
                         UNIX_TIMESTAMP(now())-UNIX_TIMESTAMP(start_time)
                     )         
                ) as complete FROM ".$prefix."slahistory 
                GROUP BY 
                    object_id     
             ) as s ON slahistory_main.object_id = s.object_id  
         GROUP BY 
            slahistory_main.object_id,
            slahistory_main.sla_state;
";
    }
    
    private static function registerPsqlQueries($prefix) {
        $registry = Doctrine_Manager::getInstance()->getQueryRegistry(); 
        $query_wDowntime = "
        WITH slatable AS (
            SELECT 
                (state*(scheduled_downtime-1)*-1) as sla_state, 
                object_id, 
                scheduled_downtime, 
                SUM(
                    date_part('epoch',COALESCE(
                        acknowledgement_time-start_time,
                        end_time-start_time,
                        CURRENT_DATE-start_time
                    ))
                 ) AS duration 
             FROM ".$prefix."slahistory
             GROUP BY 
                 sla_state, 
                 object_id, 
                 scheduled_downtime
        ),
        completeDuration AS (
             SELECT object_id,
                SUM(
                    date_part('epoch',COALESCE(
                        acknowledgement_time-start_time,
                        end_time-start_time,
                        CURRENT_DATE-start_time
                    ))
                ) AS complete 
              FROM ".$prefix."slahistory 
              GROUP BY object_id
        ) 
        SELECT 
            s.object_id, 
            s.sla_state, 
            SUM(s.duration/c.complete*100)
        FROM slatable s 
        INNER JOIN 
            completeDuration c 
            ON 
                c.object_id = s.object_id          
        GROUP BY s.object_id, s.sla_state";
    
        }
       
    
}