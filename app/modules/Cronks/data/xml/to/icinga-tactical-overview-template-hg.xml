<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<template>
    
    <!-- 
    	Meta description of the templates, that anybody
    	knows what the template is doing
    -->
    <meta>
        <parameter name="name">Default template for Tactical Overview</parameter>
        <parameter name="description">Displays a Tactical Overview</parameter>
        <parameter name="author">icinga-web developers</parameter>
    </meta>

	<!--
		data sources 
	-->
	<datasources>

		<datasource id="HOSTGROUPS">
			<source_type>IcingaApi</source_type>
			<target>IcingaApi::TARGET_HOSTGROUP</target>
			<columns>HOSTGROUP_ALIAS, HOSTGROUP_NAME</columns>
		</datasource>

		<datasource id="SERVICEGROUPS">
			<source_type>IcingaApi</source_type>
			<target>IcingaApi::TARGET_SERVICEGROUP</target>
			<columns>SERVICEGROUP_ALIAS, SERVICEGROUP_NAME</columns>
		</datasource>

		<datasource id="HOST_STATUS_SUMMARY">
			<source_type>IcingaApi</source_type>
			<target>IcingaApi::TARGET_HOST_STATUS_SUMMARY</target>
			<columns>HOST_CURRENT_STATE,HOST_STATE_COUNT</columns>
		</datasource>

		<datasource id="SERVICE_STATUS_SUMMARY">
			<source_type>IcingaApi</source_type>
			<target>IcingaApi::TARGET_SERVICE_STATUS_SUMMARY</target>
			<columns>SERVICE_CURRENT_STATE,SERVICE_STATE_COUNT</columns>
		</datasource>

		<datasource id="HG_NAME">
			<source_type>IcingaApi</source_type>
			<target>IcingaApi::TARGET_HOSTGROUP</target>
			<columns>HOSTGROUP_ALIAS, HOSTGROUP_NAME</columns>
		</datasource>

		<datasource id="SG_NAME">
			<source_type>IcingaApi</source_type>
			<target>IcingaApi::TARGET_SERVICEGROUP</target>
			<columns>SERVICEGROUP_ALIAS, SERVICEGROUP_NAME</columns>
		</datasource>

		<datasource id="HOST_STATUS_UP">
			<source_type>IcingaApi</source_type>
			<target>IcingaApi::TARGET_HOST</target>
			<columns>HOST_OBJECT_ID</columns>
			<search_type>IcingaApi::SEARCH_TYPE_COUNT</search_type>
			<filter>
				<columns>
					<column>HOST_CURRENT_STATE</column>
					<value>0</value>
				</columns>
			</filter>
		</datasource>

		<datasource id="HOST_STATUS_DOWN">
			<source_type>IcingaApi</source_type>
			<target>IcingaApi::TARGET_HOST</target>
			<columns>HOST_OBJECT_ID</columns>
			<search_type>IcingaApi::SEARCH_TYPE_COUNT</search_type>
			<filter>
				<columns>
					<column>HOST_CURRENT_STATE</column>
					<value>1</value>
				</columns>
			</filter>
		</datasource>

		<datasource id="HOST_STATUS_UNREACHABLE">
			<source_type>IcingaApi</source_type>
			<target>IcingaApi::TARGET_HOST</target>
			<columns>HOST_OBJECT_ID</columns>
			<search_type>IcingaApi::SEARCH_TYPE_COUNT</search_type>
			<filter>
				<columns>
					<column>HOST_CURRENT_STATE</column>
					<value>2</value>
				</columns>
			</filter>
		</datasource>

		<datasource id="SERVICE_HOST_STATUS_UP">
			<source_type>IcingaApi</source_type>
			<target>IcingaApi::TARGET_SERVICE</target>
			<columns>HOST_OBJECT_ID</columns>
			<search_type>IcingaApi::SEARCH_TYPE_COUNT</search_type>
			<filter>
				<columns>
					<column>HOST_CURRENT_STATE</column>
					<value>0</value>
				</columns>
			</filter>
		</datasource>

		<datasource id="SERVICE_HOST_STATUS_DOWN">
			<source_type>IcingaApi</source_type>
			<target>IcingaApi::TARGET_SERVICE</target>
			<columns>HOST_OBJECT_ID</columns>
			<search_type>IcingaApi::SEARCH_TYPE_COUNT</search_type>
			<filter>
				<columns>
					<column>HOST_CURRENT_STATE</column>
					<value>1</value>
				</columns>
			</filter>
		</datasource>

		<datasource id="SERVICE_HOST_STATUS_UNREACHABLE">
			<source_type>IcingaApi</source_type>
			<target>IcingaApi::TARGET_SERVICE</target>
			<columns>HOST_OBJECT_ID</columns>
			<search_type>IcingaApi::SEARCH_TYPE_COUNT</search_type>
			<filter>
				<columns>
					<column>HOST_CURRENT_STATE</column>
					<value>2</value>
				</columns>
			</filter>
		</datasource>

		<datasource id="SERVICE_STATUS_OK">
			<source_type>IcingaApi</source_type>
			<target>IcingaApi::TARGET_SERVICE</target>
			<columns>SERVICE_OBJECT_ID</columns>
			<search_type>IcingaApi::SEARCH_TYPE_COUNT</search_type>
			<filter>
				<columns>
					<column>SERVICE_CURRENT_STATE</column>
					<value>0</value>
				</columns>
			</filter>
		</datasource>

		<datasource id="SERVICE_STATUS_WARNING">
			<source_type>IcingaApi</source_type>
			<target>IcingaApi::TARGET_SERVICE</target>
			<columns>SERVICE_OBJECT_ID</columns>
			<search_type>IcingaApi::SEARCH_TYPE_COUNT</search_type>
			<filter>
				<columns>
					<column>SERVICE_CURRENT_STATE</column>
					<value>1</value>
				</columns>
			</filter>
		</datasource>

		<datasource id="SERVICE_STATUS_CRITICAL">
			<source_type>IcingaApi</source_type>
			<target>IcingaApi::TARGET_SERVICE</target>
			<columns>SERVICE_OBJECT_ID</columns>
			<search_type>IcingaApi::SEARCH_TYPE_COUNT</search_type>
			<filter>
				<columns>
					<column>SERVICE_CURRENT_STATE</column>
					<value>2</value>
				</columns>
			</filter>
		</datasource>

		<datasource id="SERVICE_STATUS_UNKNOWN">
			<source_type>IcingaApi</source_type>
			<target>IcingaApi::TARGET_SERVICE</target>
			<columns>SERVICE_OBJECT_ID</columns>
			<search_type>IcingaApi::SEARCH_TYPE_COUNT</search_type>
			<filter>
				<columns>
					<column>SERVICE_CURRENT_STATE</column>
					<value>3</value>
				</columns>
			</filter>
		</datasource>

	</datasources>

    <!--
    	html template
    -->
    <template_code>
    	<hg_status>
    		<![CDATA[
    			<table border="0" cellpadding="0" cellspacing="0">
    				<tr>
    					<td>
							<div class="icinga-status-container">
    							<div class="icinga-status-label"><b>${HG_NAME:HOSTGROUP_ALIAS} - Hosts</b></div>
    							
								${if:${HOST_STATUS_UP:COUNT_HOST_OBJECT_ID} > 0}
									<div id="tohg-hosts-${HG_NAME:HOSTGROUP_ALIAS}-UP" class="icinga-status icinga-status-up"><span>
										${SERVICE_HOST_STATUS_UP:COUNT_HOST_OBJECT_ID} UP
									</span></div>
								${/if}
								
								${if:${HOST_STATUS_DOWN:COUNT_HOST_OBJECT_ID} > 0}
									<div id="tohg-hosts-${HG_NAME:HOSTGROUP_ALIAS}-DOWN" class="icinga-status icinga-status-down"><span>
										${SERVICE_HOST_STATUS_DOWN:COUNT_HOST_OBJECT_ID} DOWN
									</span></div>
								${/if}
								
								${if:${HOST_STATUS_UNREACHABLE:COUNT_HOST_OBJECT_ID} > 0}
									<div id="tohg-hosts-${HG_NAME:HOSTGROUP_ALIAS}-UNREACHABLE" class="icinga-status icinga-status-unreachable"><span>
										${SERVICE_HOST_STATUS_UNREACHABLE:COUNT_HOST_OBJECT_ID} UNREACHABLE
									</span></div>
								${/if}
							</div>
						</td>
    					<td>
							<div class="icinga-status-container">
    							<div class="icinga-status-label"><b>${HG_NAME:HOSTGROUP_ALIAS} - Services</b></div>
    							
								${if:${SERVICE_STATUS_OK:COUNT_SERVICE_OBJECT_ID} > 0}
									<div id="tohg-services-${HG_NAME:HOSTGROUP_ALIAS}-OK" class="icinga-status icinga-status-ok"><span>
										${SERVICE_STATUS_OK:COUNT_SERVICE_OBJECT_ID} OK
									</span></div>
								${/if}
								
								${if:${SERVICE_STATUS_WARNING:COUNT_SERVICE_OBJECT_ID} > 0}
									<div id="tohg-services-${HG_NAME:HOSTGROUP_ALIAS}-WARNING" class="icinga-status icinga-status-warning"><span>
										${SERVICE_STATUS_WARNING:COUNT_SERVICE_OBJECT_ID} WARNING
									</span></div>
								${/if}
								
								${if:${SERVICE_STATUS_CRITICAL:COUNT_SERVICE_OBJECT_ID} > 0}
									<div id="tohg-services-${HG_NAME:HOSTGROUP_ALIAS}-CRITICAL" class="icinga-status icinga-status-critical"><span>
										${SERVICE_STATUS_CRITICAL:COUNT_SERVICE_OBJECT_ID} CRITICAL
									</span></div>
								${/if}
								
								${if:${SERVICE_STATUS_UNKNOWN:COUNT_SERVICE_OBJECT_ID} > 0}
									<div id="tohg-services-${HG_NAME:HOSTGROUP_ALIAS}-UNKNOWN" class="icinga-status icinga-status-unknown"><span>
										${SERVICE_STATUS_UNKNOWN:COUNT_SERVICE_OBJECT_ID} UNKNOWN
									</span></div>
								${/if}
							</div>
						</td>
					</tr>
				</table>
				<script type="text/javascript">
					Ext.onReady(function() {
						var l = Cronk.util.InterGridUtil.clickGridLink;
						var s = {OK:0,WARNING:1,CRITICAL:2,UNKNOWN:3};
						var h = {UP:0,DOWN:1,UNREACHABLE:2};
						var r = {
							'tohg-services-${HG_NAME:HOSTGROUP_ALIAS}-': ['icinga-service-template', s, 'service_status'],
							'tohg-hosts-${HG_NAME:HOSTGROUP_ALIAS}-': ['icinga-host-template', h, 'host_status']
						};
						
						Ext.iterate(r, function (ip, m) {
							Ext.iterate(m[1], function(sn, si) {
								var f = { 'hostgroup_name': '${HG_NAME:HOSTGROUP_NAME}' };
								f[m[2]] = si;
								l(ip+sn, m[0], f, '${HG_NAME:HOSTGROUP_NAME} ' + sn);
							});
						});
					});
				</script>
    		]]>
    	</hg_status>

    	<sg_status>
    		<![CDATA[
    			<table border="0" cellpadding="0" cellspacing="0">
    				<tr>
    					<td>
							<div class="icinga-status-container">
    							<div class="icinga-status-label">${SG_NAME:SERVICEGROUP_ALIAS} - Hosts</div>
    							
								${if:${SERVICE_HOST_STATUS_UP:COUNT_HOST_OBJECT_ID} > 0}
									<div id="tosg-hosts-${SG_NAME:SERVICEGROUP_ALIAS}-UP" class="icinga-status icinga-status-up"><span>
										${SERVICE_HOST_STATUS_UP:COUNT_HOST_OBJECT_ID} UP
									</span></div>
								${/if}
								
								${if:${SERVICE_HOST_STATUS_DOWN:COUNT_HOST_OBJECT_ID} > 0}
									<div id="tosg-hosts-${SG_NAME:SERVICEGROUP_ALIAS}-DOWN" class="icinga-status icinga-status-down"><span>
										${SERVICE_HOST_STATUS_DOWN:COUNT_HOST_OBJECT_ID} DOWN
									</span></div>
								${/if}
								
								${if:${SERVICE_HOST_STATUS_UNREACHABLE:COUNT_HOST_OBJECT_ID} > 0}
									<div id="tosg-hosts-${SG_NAME:SERVICEGROUP_ALIAS}-UNREACHABLE" class="icinga-status icinga-status-unreachable"><span>
										${SERVICE_HOST_STATUS_UNREACHABLE:COUNT_HOST_OBJECT_ID} UNREACHABLE
									</span></div>
								${/if}
							</div>
						</td>
    					<td>
							<div class="icinga-status-container">
    							<div class="icinga-status-label">${SG_NAME:SERVICEGROUP_ALIAS} - Services</div>
    							
								${if:${SERVICE_STATUS_OK:COUNT_SERVICE_OBJECT_ID} > 0}
									<div id="tosg-services-${SG_NAME:SERVICEGROUP_ALIAS}-OK" class="icinga-status icinga-status-ok"><span>
										${SERVICE_STATUS_OK:COUNT_SERVICE_OBJECT_ID} OK
									</span></div>
								${/if}
								
								${if:${SERVICE_STATUS_WARNING:COUNT_SERVICE_OBJECT_ID} > 0}
									<div id="tosg-services-${SG_NAME:SERVICEGROUP_ALIAS}-WARNING" class="icinga-status icinga-status-warning"><span>
										${SERVICE_STATUS_WARNING:COUNT_SERVICE_OBJECT_ID} WARNING
									</span></div>
								${/if}
								
								${if:${SERVICE_STATUS_CRITICAL:COUNT_SERVICE_OBJECT_ID} > 0}
									<div id="tosg-services-${SG_NAME:SERVICEGROUP_ALIAS}-CRITICAL" class="icinga-status icinga-status-critical"><span>
										${SERVICE_STATUS_CRITICAL:COUNT_SERVICE_OBJECT_ID} CRITICAL
									</span></div>
								${/if}
								
								${if:${SERVICE_STATUS_UNKNOWN:COUNT_SERVICE_OBJECT_ID} > 0}
									<div id="tosg-services-${SG_NAME:SERVICEGROUP_ALIAS}-UNKNOWN" class="icinga-status icinga-status-unknown"><span>
										${SERVICE_STATUS_UNKNOWN:COUNT_SERVICE_OBJECT_ID} UNKNOWN
									</span></div>
								${/if}
							</div>
						</td>
					</tr>
				</table>
				<script type="text/javascript">
					Ext.onReady(function() {
						var l = Cronk.util.InterGridUtil.clickGridLink;
						var s = {OK:0,WARNING:1,CRITICAL:2,UNKNOWN:3};
						var h = {UP:0,DOWN:1,UNREACHABLE:2};
						var r = {
							'tosg-services-${SG_NAME:SERVICEGROUP_ALIAS}-': ['icinga-service-template', s, 'service_status']
							// 'tosg-hosts-${SG_NAME:SERVICEGROUP_ALIAS}-': ['icinga-host-template', h, 'host_status']
						};
						
						Ext.iterate(r, function (ip, m) {
							Ext.iterate(m[1], function(sn, si) {
								var f = { 'servicegroup_name': '${SG_NAME:SERVICEGROUP_NAME}' };
								f[m[2]] = si;
								l(ip+sn, m[0], f, '${SG_NAME:SERVICEGROUP_NAME} ' + sn);
							});
						});
					});
				</script>
    		]]>
    	</sg_status>

		<status_summary>
			<![CDATA[
				<?php
					$hosts = $t->ds2Array('HOST_STATUS_SUMMARY', array($filter), false, 'HOST_CURRENT_STATE');
					$services = $t->ds2Array('SERVICE_STATUS_SUMMARY', array($filter), false, 'SERVICE_CURRENT_STATE');

					if (!$hosts || !$services) {
						return;
					}

					$host_states = new IcingaHostStateInfo(null);
					$service_states = new IcingaServiceStateInfo(null);
				?>

				<h4><?php echo $title ?></h4>

				<table border="0" cellpadding="0" cellspacing="0">
    				<tr>
    					<td>
							<div class="icinga-status-container">
								<?php
									foreach ($host_states->getStateList() as $sid=>	$sname) {
										if (isset($hosts[$sid])) {
											$host_states->setStateById($sid);
											echo $host_states->getCurrentStateAsHtml($hosts[$sid]['HOST_STATE_COUNT']. ' %s');
										}
									}
								?>
							</div>
						</td>

						<td>
							<div class="icinga-status-container">
								<?php
									foreach ($service_states->getStateList() as $sid=>	$sname) {
										if (isset($services[$sid])) {
											$service_states->setStateById($sid);
											echo $service_states->getCurrentStateAsHtml($services[$sid]['SERVICE_STATE_COUNT']. ' %s');
										}
									}
								?>
							</div>
						</td>
					</tr>
				</table>
			]]>
		</status_summary>

		<hostgroups>
			<![CDATA[
				<?php echo $t->ds2template('HOSTGROUPS', 'status_summary', 'count', array(
					'filter'	=> array('HOSTGROUP_NAME', '${arg.HOSTGROUP_NAME}'),
					'title'		=> '${arg.HOSTGROUP_NAME}'

				)); ?>

			]]>
		</hostgroups>

		<servicegroups>
			<![CDATA[
				<?php echo $t->ds2template('SERVICEGROUPS', 'status_summary', 'count', array(
					'filter'	=> array('SERVICEGROUP_NAME', '${arg.SERVICEGROUP_NAME}'),
					'title'		=> '${arg.SERVICEGROUP_NAME}'
				)); ?>
			]]>
		</servicegroups>

    	<locations>
    		<![CDATA[
				<tr>
					<td>${LOCATIONS:HOSTGROUP_ALIAS}</td>
					<td>${host_status}</td>
				</tr>
			]]>
    	</locations>

    	<MAIN>
	    	<![CDATA[
				<table width="100%" border="0" cellpadding="0" cellspacing="0">
					<tr>
						<td><b>Locations</b></td>
						<td><b>Services</b></td>
						<td><b>Monitoring Performance</b></td>
					</tr>
					<tr>
						<td>
								<?php echo $t->renderTemplate('hostgroups'); ?>
						</td>
						<td>
								<?php echo $t->renderTemplate('servicegroups'); ?>
						</td>
						<td>
							<?php echo $t->renderSub('icinga-tactical-overview-presets', 'performance'); ?>
						</td>					
					</tr>
				</table>
			]]>
		</MAIN>
    </template_code>
</template>