SHELL=/bin/sh
PACKAGE_TARNAME=@PACKAGE_TARNAME@
PACKAGE_NAME=@PACKAGE_NAME@
PACKAGE_VERSION=@PACKAGE_VERSION@
TAR_DIR_NAME=$(shell basename `pwd`)
prefix=@prefix@
exec_prefix=@exec_prefix@
LOGDIR=@localstatedir@
CFGDIR=@sysconfdir@
BINDIR=@bindir@
CGIDIR=@sbindir@
HTMLDIR=@datarootdir@
INSTALL=@INSTALL@
INSTALL_OPTS=@INSTALL_OPTS@
BIN_USER=@bin_user@
BIN_GROUP=@bin_group@
WEB_USER=@web_user@
WEB_GROUP=@web_group@
SED=@SED@
PHP=@PHP@
PC=bin/phing -f etc/build.xml
INC_MAKE_FILES=./etc/make/files.mk

none:
	@echo "Please supply a command line argument (i.e. 'make install')."
	@echo ""
	@echo "Generic targets: install, clean"
	@echo ""
	@echo "Other usefull targets:"
	@echo "\ttestdeps - test the php dependencies"
	@echo "\tcreate-tarball - creates a tarball for packaging"
	@echo "\tdevclean - to a sourcecode ready for ci or packaging" 
	@echo ""
	@echo "Experimental targets:"
	@echo "\tmake db-initialize - create the db"
	@echo "\tmake db-deinitialize - reverse the path (removes all data and drop the relations)"
	@echo "\tmake db-upgrade - tries to upgrade from a available db revision"
	@echo "\tmake db-drop - create the entire db"
	@echo ""

include $(INC_MAKE_FILES)

install-files-list:
	$(SED) -i '/^# INSTALL_FILES_BEGIN/,/^# INSTALL_FILES_END/{D}' $(INC_MAKE_FILES)
	./bin/create-makefile.sh >> $(INC_MAKE_FILES)

remove-temp-files:
	./bin/rabbit.sh
	
clean:

distclean: clean
	rm -f \
		Makefile \
		config.log \
		config.status \
		etc/build.properties

devclean: remove-temp-files distclean cacheclean install-files-list

create-tarball:
	tar -czf ../$(PACKAGE_TARNAME)-$(PACKAGE_VERSION).tar.gz ../$(TAR_DIR_NAME)

cacheclean:
	rm -rf app/cache/config/*.php

testdeps:
	 $(PHP) bin/testdeps.php

fix-priv:
	chown -R $(WEB_USER).$(WEB_GROUP) $(DESTDIR)$(prefix)/app/cache
	chmod -R 775 $(DESTDIR)$(prefix)/app/cache
	chmod +x \
		$(DESTDIR)$(prefix)/bin/agavi \
		$(DESTDIR)$(prefix)/bin/create-makefile.sh \
		$(DESTDIR)$(prefix)/bin/doctrinemodels.php \
		$(DESTDIR)$(prefix)/bin/phing \
		$(DESTDIR)$(prefix)/bin/rabbit.sh \
		$(DESTDIR)$(prefix)/bin/testdeps.php

fix-libs:
	rm -rf $(DESTDIR)$(prefix)/pub/js/ext3
	ln -s $(DESTDIR)$(prefix)/lib/ext3 $(DESTDIR)$(prefix)/pub/js

install: inc-install-files fix-priv fix-libs

db-initialize:
	$(PC) db-initialize

db-deinitialize:
	$(PC) db-initialize

db-drop:
	$(PC) db-drop

db-upgrade:
	$(PC) db-upgrade

