SHELL=/bin/sh
PACKAGE_TARNAME=@PACKAGE_TARNAME@
PACKAGE_NAME=@PACKAGE_NAME@
PACKAGE_VERSION=@PACKAGE_VERSION@
TAR_DIR_NAME=$(shell basename `pwd`)
prefix=@prefix@
exec_prefix=@exec_prefix@
LOGDIR=@localstatedir@
CFGDIR=@sysconfdir@
BINDIR=@bindir@
CGIDIR=@sbindir@
HTMLDIR=@datarootdir@
INSTALL=@INSTALL@
INSTALL_OPTS=@INSTALL_OPTS@
BIN_USER=@bin_user@
BIN_GROUP=@bin_group@
WEB_USER=@web_user@
WEB_GROUP=@web_group@
SED=@SED@
PHP=@PHP@
PHING=@PHING@
PHING_CALL=bin/phing -f etc/build.xml
API_DIR=@icinga_api@
INC_MAKE_FILES=./etc/make/files.mk
LOC_PO=app/data/i18n/po
LOC_MO=app/data/i18n/mo
LOC_TEMPLATE=$(LOC_PO)/templates/default.pot

none:
#	@printf "\t%-18s - %s\n" "" ""
	@printf "Please supply a command line argument (i.e. 'make install').\n\n"
	@printf "Generic targets: install, clean\n\n"
	@printf "Other usefull targets:\n"
	@printf "\t%-18s - %s\n" "testdeps" "test php dependencies"
	@printf "\t%-18s - %s\n" "create-tarball" "creates a tarball for packaging"
	@printf "\t%-18s - %s\n" "devclean" "make source ready for commit or packaging"
	@printf "\t%-18s - %s\n" "cacheclean" "purges the agavi xml cache"
	
	@printf "\nDatabase (web) targets:\n"
	@printf "\t%-18s - %s\n" "db-initialize" "create the db"
	@printf "\t%-18s - %s\n" "db-deinitialize" "reverse the path (removes all data and drop the relations)"
	@printf "\t%-18s - %s\n" "db-upgrade" "tries to upgrade from a available db revision"
	@printf "\t%-18s - %s\n" "db-drop" "drop the entire db"
	@printf "\t%-18s - %s\n" "db-purge-userprefs" "purge existing user preferences"

	@printf "\nI18n targets:\n"
	@printf "\t%-18s - %s\n" "loc-update-catalog" "Create a initial locale from source (default.po)"
	@printf "\t%-18s - %s\n" "loc-compile" "Compile language files into mo and json"

	@printf "\nScheduler targets:\n"
	@printf "\t%-18s - %s\n" "scheduler-install" "Install the icingaScheduler cronkjob"
	@printf "\t%-18s - %s\n" "scheduler-remove" "remove the icingaScheduler cronkjob"
	@printf "\n\n"
	
include $(INC_MAKE_FILES)
	
clean:

distclean: clean
	rm -f \
		Makefile \
		config.log \
		config.status \
		etc/build.properties
		
configclean:
	rm -f \
		app/config/databases.xml

remove-temp-files:
	bin/rmtmp-files.sh

devclean: remove-temp-files distclean cacheclean logclean make-create-files configclean

cleanall: distclean cacheclean configclean logclean 

create-tarball:
	tar -czf ../$(PACKAGE_TARNAME)-$(PACKAGE_VERSION).tar.gz ../$(TAR_DIR_NAME)

cacheclean:
	rm -rf app/cache/config/*.php

logclean:
	rm -rf app/data/log/*.log

testdeps:
	 $(PHP) bin/testdeps.php

fix-priv:
	chown -R $(WEB_USER).$(WEB_GROUP) \
		$(DESTDIR)$(prefix)/app/cache \
		$(DESTDIR)$(prefix)/app/data/log
	chmod -R 775 $(DESTDIR)$(prefix)/app/cache
	chmod +x \
		$(DESTDIR)$(prefix)/bin/agavi \
		$(DESTDIR)$(prefix)/bin/create-makefile.sh \
		$(DESTDIR)$(prefix)/bin/create-rescuescheme.sh \
		$(DESTDIR)$(prefix)/bin/doctrinemodels.php \
		$(DESTDIR)$(prefix)/bin/phing \
		$(DESTDIR)$(prefix)/bin/testdeps.php \
		$(DESTDIR)$(prefix)/bin/loc-create-catalog.pl \
		$(DESTDIR)$(prefix)/bin/loc-create-json.sh \
		$(DESTDIR)$(prefix)/bin/loc-create-mo.sh \
		$(DESTDIR)$(prefix)/bin/loc-merge-template.sh \
		$(DESTDIR)$(prefix)/bin/rmtmp-files.sh

fix-libs:
	rm -rf $(DESTDIR)$(prefix)/pub/js/ext3
	ln -sf $(DESTDIR)$(prefix)/lib/ext3 $(DESTDIR)$(prefix)/pub/js
	ln -sf $(API_DIR) $(DESTDIR)$(prefix)/lib/icinga-api

install:
	@printf "Install %d dirs with %d files (quiet)\n" "$(INC_DIRS)" "$(INC_FILES)"
	$(MAKE) -s inc-install-files
	$(MAKE) fix-priv fix-libs

db-initialize:
	$(PHING_CALL) db-initialize

db-deinitialize:
	$(PHING_CALL) db-initialize

db-drop:
	$(PHING_CALL) db-drop

db-upgrade:
	$(PHING_CALL) db-upgrade

db-purge-userprefs:
	$(PHING_CALL) db-purge-userprefs

install-files-list: make-create-files

make-create-files:
	$(SED) -i '/^# INSTALL_FILES_BEGIN/,/^# INSTALL_FILES_END/{D}' $(INC_MAKE_FILES)
	./bin/create-makefile.sh ./ >> $(INC_MAKE_FILES)

loc-update-catalog:
	./bin/loc-create-catalog.pl --base=./ --out=$(LOC_PO)/templates/default.pot
	./bin/loc-merge-template.sh $(LOC_PO)/templates/default.pot $(LOC_PO)

loc-compile: loc-create-mo loc-create-json

loc-create-mo:
	./bin/loc-create-mo.sh $(LOC_PO) $(LOC_MO)

loc-create-json:
	./bin/loc-create-json.sh $(LOC_PO) $(LOC_MO)

submodule-init:
	git submodule init app/data/i18n/po

submodule-update:
	cd app/data/i18n/po
	git checkout master
	git pull origin master
	cd -
	git submodule update

locclean:
	rm -f \
		$(LOC_MO)/*.mo \
		$(LOC_MO)/*.json

scheduler-install:
	$(PHING_CALL) scheduler-install -DPATH_Icinga=$(prefix)

scheduler-remove:
	$(PHING_CALL) scheduler-remove -DPATH_Icinga=$(prefix)
